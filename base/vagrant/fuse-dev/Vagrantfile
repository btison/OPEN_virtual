# -*- mode: ruby -*-
# vi: set ft=ruby :

VAGRANTFILE_API_VERSION = "2"
$vmMemory = ENV['FUSE_VM_MEMORY'] || 3000
$mavenVersion = ENV['MAVEN_VERSION'] || "3.2.3"
$gitRepo = ENV['GIT_REPO'] || "https://github.com/FuseByExample/rest-dsl-in-action.git"
$fuseVersion = ENV['FUSE_VERSION'] || "6.2.1.redhat-084"
$hostname = "fuse"

$provisionScript = <<SCRIPT

# Local variables
VM_MEMORY="#{$vmMemory}"
MAVEN_VERSION="#{$mavenVersion}"
GIT_REPO="#{$gitRepo}"
FUSE_VERSION="#{$fuseVersion}"

# Check memory
echo "=========================================================================="
echo "Using VM Memory of ${VM_MEMORY} MB"
if [ ${VM_MEMORY} -lt 3000 ]; then
  echo "NOTE: We recommend at least 3000 MB for running with JBoss Fuse and Fabric Containers."
  echo "      You can specify this with an environment variable FUSE_VM_MEMORY"
  echo "      E.g. when creating the VM with : 'FUSE_VM_MEMORY=3000 vagrant up'"
fi
echo "=========================================================================="


# Install Git, 
echo 'Install git, wget, unzip'
sudo dnf -y install wget git unzip nfs-utils firewalld

# Configure firewall to allow to use nfs

systemctl status firewalld

sudo firewall-cmd --permanent --add-service=nfs &&
sudo firewall-cmd --permanent --add-service=rpc-bind &&
sudo firewall-cmd --permanent --add-service=mountd &&
sudo firewall-cmd --permanent --add-port=8100-9999/tcp &&
sudo firewall-cmd --reload

# Create Tmp dir
# echo "Create Temp Directory under vagrant home"
# mkdir -p $vagrant_home_dir/tmp

# Download and install JDK
echo "Download and install JDK8"

pushd $vagrant_home_dir/tmp
wget --quiet --no-cookies --no-check-certificate --header "Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u73-b02/jdk-8u73-linux-x64.rpm
rpm -Uhv jdk-8u73-linux-x64.rpm
popd

# Download & install Apache Maven ${MAVEN_VERSION}
echo "Download & install Apache Maven ${MAVEN_VERSION}"
pushd /usr/local
wget --quiet  http://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
tar -vxf apache-maven-${MAVEN_VERSION}-bin.tar.gz
sudo rm -f apache-maven-${MAVEN_VERSION}-bin.tar.gz
popd


# Set env Variables for Maven, JDK & export them
echo "Set env Variables for Maven, JDK & export them"
su vagrant -c 'cat <<EOF >> /home/vagrant/.bash_profile

# Java Home
export JAVA_HOME=/usr/java/jdk1.8.0_73
export PATH=\$PATH:\$JAVA_HOME/bin

# Maven Home
export M2_HOME=/usr/local/apache-maven-$mavenVersion
export PATH=\$PATH:\$M2_HOME/bin
EOF'

# Install JBoss Fuse, change permissions and add admin user
echo "Install JBoss Fuse ${FUSE_VERSION}"
mkdir -p /home/vagrant/fuse
pushd /home/vagrant/fuse
unzip -oq ../tmp/jboss-fuse-full-${FUSE_VERSION}.zip
chown -R vagrant:vagrant /home/vagrant/fuse
sed -i "s|#admin|admin|" /home/vagrant/fuse/jboss-fuse-${FUSE_VERSION}/etc/users.properties

# Start JBoss Fuse
echo "Start JBoss Fuse"
su vagrant -c './jboss-fuse-${FUSE_VERSION}/bin/start'
popd

# Install Demo/Poc project
echo "Install Demo/Poc project"
su vagrant -c 'mkdir -p /home/vagrant/demo'
pushd /home/vagrant/demo
su vagrant -c 'git clone ${GIT_REPO}'
cd rest-dsl-in-action
mvn clean install
popd

SCRIPT


Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  config.vm.hostname = $hostname

  config.vm.define "libvirt" do |cfg|
    cfg.vm.box = "fedora23-libvirt"
    cfg.vm.network :private_network, 
        :ip => "172.28.128.4",
        :libvirt__network_name => "private"
        
    #cfg.vm.network :public_network,
    #  :dev => "virbr0",
    #  :mode => "bridge",
    #  :type => "bridge"
  end

  config.vm.define "virtualbox" do |cfg|
    cfg.vm.box = "fedora23-virtualbox"
    cfg.vm.network "private_network", ip: "172.28.128.4"
  end

  # Use NFS for shared folders for better performance
  config.vm.synced_folder "tmp/", "/home/vagrant/tmp", nfs: true

  # set auto_update to false, if you do NOT want to check the correct 
  # additions version when booting this machine
  config.vbguest.auto_update = false

  # do NOT download the iso file from a webserver
  config.vbguest.no_remote = true

  config.vm.provider "virtualbox" do |v|
    v.memory = $vmMemory
    v.cpus = 2
    v.name = "dev-fuse-vm"
    v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
  end

  config.vm.provider :libvirt do |v, override|
    v.memory = $vmMemory
    v.driver = "kvm"
    v.cpus = 2
    v.volume_cache = "unsafe"
    v.machine_virtual_size = 45
    v.management_network_name = "default"
    # VNC setup
    v.graphics_type = "vnc"
    v.graphics_ip = "172.28.128.4"
    v.graphics_port = 5900
    v.graphics_password = ""
  end

  config.vm.provision "shell" do |s|
    s.inline     = $provisionScript, 
    s.keep_color = true
  end

end
